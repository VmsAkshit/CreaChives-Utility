<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Creachive</title>
    
    <!-- 1. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React and ReactDOM (The Engine) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel (To understand JSX code in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load Firebase (The Database/Server) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Custom Styles -->
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Home: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            MessageCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            PlusCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Heart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            CheckCheck: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></svg>,
            UserPlus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        };

        // --- FIREBASE INITIALIZATION LOGIC ---
        const PUBLIC_DATA = 'creachive_public_v2';
        let auth, db;

        // 1. Define your GitHub config here. (It is null by default)
        // WHEN YOU DEPLOY TO GITHUB, REPLACE 'null' WITH YOUR CONFIG OBJECT:
        // const githubConfig = { apiKey: "...", ... };
        const githubConfig = {
            apiKey: "AIzaSyAutcAiOWpnvgW7GQg_JffSj2GbzcHcjXI",
            authDomain: "creachives.firebaseapp.com",
            projectId: "creachives",
            storageBucket: "creachives.firebasestorage.app",
            messagingSenderId: "232994696822",
            appId: "1:232994696822:web:938da2ae01525238637957",
            measurementId: "G-0C4CZZ31XD"
        };

        try {
            // Priority 1: Use GitHub config if provided by user
            if (githubConfig) {
                firebase.initializeApp(githubConfig);
            } 
            // Priority 2: Use Preview Environment config (Auto-magical!)
            else if (typeof __firebase_config !== 'undefined') {
                firebase.initializeApp(JSON.parse(__firebase_config));
            } 
            // Fallback: No config found
            else {
                console.warn("No Firebase config found. App will show setup screen.");
            }

            // If initialized successfully, grab auth and db
            if (firebase.apps.length > 0) {
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- COMPONENTS ---

        const AuthScreen = ({ onJoin }) => {
            const [name, setName] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                setLoading(true);
                await onJoin(name);
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full text-center">
                        <div className="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-blue-200 shadow-xl">
                            <span className="text-white font-bold text-4xl">C</span>
                        </div>
                        <h1 className="text-2xl font-bold text-gray-900 mb-2">Welcome to Creachive</h1>
                        <p className="text-gray-500 mb-8">
                            Join the network. Connect securely.<br/>
                            <span className="text-xs text-blue-500 font-medium">Feed • Stories • Chat</span>
                        </p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="text-left">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="e.g. Alex Doe"
                                    className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 transition-all outline-none"
                                    required
                                />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md">
                                {loading ? 'Joining...' : 'Join Now'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Navigation = ({ activeTab, setActiveTab, currentUser }) => {
            const navItems = [
                { id: 'feed', icon: Icons.Home, label: 'Feed' },
                { id: 'chats', icon: Icons.MessageCircle, label: 'Chats' },
                { id: 'profile', icon: Icons.Settings, label: 'Profile' },
            ];

            const handleLogout = () => {
                auth.signOut();
                window.location.reload();
            };

            return (
                <React.Fragment>
                    {/* Desktop Sidebar */}
                    <div className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 z-20">
                        <div className="p-6 flex items-center space-x-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                                <span className="text-white font-bold text-xl">C</span>
                            </div>
                            <span className="text-2xl font-bold text-blue-600">Creachive</span>
                        </div>
                        <nav className="flex-1 px-4 space-y-2">
                            {navItems.map((item) => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors ${activeTab === item.id ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>
                                    <item.icon size={24} />
                                    <span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-gray-200">
                            <div className="flex items-center space-x-3 p-2 rounded-xl mb-2 bg-gray-50">
                                <img src={currentUser?.avatar} alt="Me" className="w-10 h-10 rounded-full bg-gray-200" />
                                <div className="flex-1 min-w-0">
                                    <p className="font-medium text-gray-900 truncate">{currentUser?.name}</p>
                                    <p className="text-[10px] text-gray-400 truncate font-mono">ID: {currentUser?.id?.slice(0,6)}...</p>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center space-x-2 text-red-500 text-sm py-2 hover:bg-red-50 rounded-lg transition">
                                <Icons.LogOut size={16} />
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>

                    {/* Mobile Bottom Bar */}
                    <div className="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 z-50 px-2 pb-safe">
                        {navItems.map((item) => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === item.id ? 'text-blue-600' : 'text-gray-500'}`}>
                                <item.icon size={24} strokeWidth={activeTab === item.id ? 2.5 : 2} />
                                <span className="text-[10px] font-medium">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </React.Fragment>
            );
        };

        const Feed = ({ currentUser }) => {
            const [posts, setPosts] = useState([]);
            const [stories, setStories] = useState([]);
            const [newPostContent, setNewPostContent] = useState('');
            const [isAddingStory, setIsAddingStory] = useState(false);
            const [storyText, setStoryText] = useState('');

            useEffect(() => {
                const unsubscribe = db.collection(`${PUBLIC_DATA}_posts`)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        setPosts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const unsubscribe = db.collection(`${PUBLIC_DATA}_stories`)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        const now = Date.now() / 1000;
                        const allStories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Filter stories older than 24h
                        setStories(allStories.filter(s => (now - (s.timestamp?.seconds || 0)) < 86400));
                    });
                return () => unsubscribe();
            }, []);

            const handleCreatePost = async () => {
                if (!newPostContent.trim()) return;
                try {
                    await db.collection(`${PUBLIC_DATA}_posts`).add({
                        content: newPostContent,
                        authorId: currentUser.id,
                        authorName: currentUser.name,
                        authorAvatar: currentUser.avatar,
                        likes: 0,
                        comments: 0,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setNewPostContent('');
                } catch (error) { console.error(error); }
            };

            const handleCreateStory = async () => {
                if (!storyText.trim()) return;
                try {
                    await db.collection(`${PUBLIC_DATA}_stories`).add({
                        content: storyText,
                        authorId: currentUser.id,
                        authorName: currentUser.name,
                        authorAvatar: currentUser.avatar,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setStoryText('');
                    setIsAddingStory(false);
                } catch (e) { console.error(e); }
            };

            return (
                <div className="flex-1 bg-gray-100 min-h-screen pb-20 md:pb-0 md:ml-64 fade-in">
                    <header className="bg-white p-4 sticky top-0 z-10 border-b border-gray-200 shadow-sm md:hidden flex justify-between items-center">
                        <span className="text-xl font-bold text-blue-600">Creachive</span>
                        <Icons.Search size={20} className="text-gray-500" />
                    </header>

                    <div className="max-w-2xl mx-auto pt-4 md:pt-8 px-0 md:px-4 space-y-4">
                        {/* Stories Bar */}
                        <div className="bg-white md:rounded-xl p-4 shadow-sm overflow-x-auto whitespace-nowrap scrollbar-hide">
                            <div className="flex space-x-4">
                                <div onClick={() => setIsAddingStory(true)} className="relative inline-block w-20 flex-shrink-0 text-center cursor-pointer group">
                                    <div className="relative w-16 h-16 mx-auto rounded-full p-1 border-2 border-dashed border-gray-300 group-hover:border-blue-500 transition">
                                        <img src={currentUser?.avatar} className="w-full h-full rounded-full object-cover opacity-80" />
                                        <div className="absolute bottom-0 right-0 bg-blue-600 rounded-full p-1 border-2 border-white">
                                            <Icons.PlusCircle size={12} className="text-white" />
                                        </div>
                                    </div>
                                    <span className="text-xs mt-2 block font-medium">Add Story</span>
                                </div>
                                {stories.map(story => (
                                    <div key={story.id} className="relative inline-block w-20 flex-shrink-0 text-center cursor-pointer">
                                        <div className="relative w-16 h-16 mx-auto rounded-full p-[2px] bg-gradient-to-tr from-yellow-400 to-purple-600">
                                            <div className="bg-white p-[2px] rounded-full w-full h-full">
                                                <img src={story.authorAvatar} className="w-full h-full rounded-full object-cover" />
                                            </div>
                                        </div>
                                        <span className="text-xs mt-2 block font-medium truncate px-1">{story.authorName}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Story Modal */}
                        {isAddingStory && (
                            <div className="bg-blue-50 p-4 md:rounded-xl border border-blue-100">
                                <h3 className="font-bold text-blue-800 mb-2">New Story</h3>
                                <input autoFocus className="w-full p-2 rounded-lg border border-blue-200 mb-2" placeholder="Caption..." value={storyText} onChange={e => setStoryText(e.target.value)} />
                                <div className="flex space-x-2">
                                    <button onClick={handleCreateStory} className="bg-blue-600 text-white px-4 py-1 rounded-lg text-sm font-bold">Share</button>
                                    <button onClick={() => setIsAddingStory(false)} className="text-gray-500 px-4 py-1 text-sm">Cancel</button>
                                </div>
                            </div>
                        )}

                        {/* Create Post */}
                        <div className="bg-white md:rounded-xl p-4 shadow-sm">
                            <div className="flex space-x-3">
                                <img src={currentUser?.avatar} className="w-10 h-10 rounded-full bg-gray-200" />
                                <textarea value={newPostContent} onChange={(e) => setNewPostContent(e.target.value)} placeholder={`What's on your mind, ${currentUser?.name}?`} className="flex-1 bg-gray-100 rounded-xl px-4 py-3 text-gray-700 outline-none resize-none" rows={2} />
                            </div>
                            <div className="flex justify-end mt-2 pt-2 border-t border-gray-50">
                                <button onClick={handleCreatePost} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-1.5 rounded-full font-medium text-sm transition-all shadow-md">Post</button>
                            </div>
                        </div>

                        {/* Posts List */}
                        {posts.map(post => (
                            <div key={post.id} className="bg-white md:rounded-xl shadow-sm overflow-hidden fade-in">
                                <div className="p-4 flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                        <img src={post.authorAvatar} className="w-10 h-10 rounded-full bg-gray-200" />
                                        <div>
                                            <h3 className="font-bold text-gray-900">{post.authorName}</h3>
                                            <p className="text-xs text-gray-500">{post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : 'Just now'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="px-4 pb-3"><p className="text-gray-800 whitespace-pre-line">{post.content}</p></div>
                                <div className="px-2 py-1 flex items-center justify-between border-t border-gray-50">
                                    <button className="flex-1 flex items-center justify-center space-x-2 py-2 text-gray-600 hover:bg-gray-50 transition"><Icons.Heart size={20} /> <span className="text-sm">Like</span></button>
                                    <button className="flex-1 flex items-center justify-center space-x-2 py-2 text-gray-600 hover:bg-gray-50 transition"><Icons.MessageCircle size={20} /> <span className="text-sm">Comment</span></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Messaging = ({ currentUser }) => {
            const [selectedUser, setSelectedUser] = useState(null);
            const [users, setUsers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [activeMessage, setActiveMessage] = useState('');
            const messagesEndRef = useRef(null);

            useEffect(() => {
                const unsubscribe = db.collection(`${PUBLIC_DATA}_users`).onSnapshot(snapshot => {
                    const all = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setUsers(all.filter(u => u.id !== currentUser.id));
                });
                return () => unsubscribe();
            }, [currentUser.id]);

            useEffect(() => {
                if (!selectedUser) return;
                const chatId = [currentUser.id, selectedUser.id].sort().join('_');
                const unsubscribe = db.collection(`${PUBLIC_DATA}_messages`)
                    .where('chatId', '==', chatId)
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snapshot => {
                        setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                return () => unsubscribe();
            }, [selectedUser, currentUser.id]);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const handleSendMessage = async () => {
                if (!activeMessage.trim() || !selectedUser) return;
                const chatId = [currentUser.id, selectedUser.id].sort().join('_');
                const text = activeMessage;
                setActiveMessage('');
                try {
                    await db.collection(`${PUBLIC_DATA}_messages`).add({
                        chatId, text, senderId: currentUser.id, senderName: currentUser.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            };

            return (
                <div className="flex-1 flex h-screen overflow-hidden bg-gray-100 md:ml-64 fade-in">
                    <div className={`flex-col bg-white border-r border-gray-200 w-full md:w-80 lg:w-96 ${selectedUser ? 'hidden md:flex' : 'flex'}`}>
                        <div className="p-4 border-b border-gray-100 bg-gray-50">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Chats</h2>
                            <div className="relative">
                                <Icons.Search size={18} className="absolute left-3 top-3 text-gray-400" />
                                <input type="text" placeholder="Search users..." className="w-full bg-white pl-10 pr-4 py-2 rounded-lg border border-gray-200 text-sm outline-none" />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            {users.length === 0 && <div className="p-4 text-center text-gray-400 text-sm">No other users yet</div>}
                            {users.map(user => (
                                <div key={user.id} onClick={() => setSelectedUser(user)} className={`flex items-center space-x-3 p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-50 ${selectedUser?.id === user.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : ''}`}>
                                    <div className="relative"><img src={user.avatar} className="w-12 h-12 rounded-full object-cover bg-gray-200" /><div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div></div>
                                    <div className="flex-1 min-w-0"><h3 className="font-semibold text-gray-900 truncate">{user.name}</h3><p className="text-xs text-gray-500 flex items-center gap-1"><Icons.Lock size={10} /> Tap to chat</p></div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {selectedUser ? (
                        <div className="flex-1 flex flex-col bg-[#eef1f5] h-full relative w-full">
                            <div className="bg-white p-3 flex items-center justify-between border-b border-gray-200 shadow-sm z-10">
                                <div className="flex items-center space-x-3">
                                    <button onClick={() => setSelectedUser(null)} className="md:hidden text-gray-600"><Icons.ArrowLeft size={24} /></button>
                                    <img src={selectedUser.avatar} className="w-10 h-10 rounded-full bg-gray-200" />
                                    <div><h3 className="font-semibold text-gray-900">{selectedUser.name}</h3><div className="flex items-center space-x-1 text-xs text-green-600"><Icons.Lock size={10} /><span>Private Chat</span></div></div>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {messages.map(msg => {
                                    const isMe = msg.senderId === currentUser.id;
                                    return (
                                        <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] rounded-2xl px-4 py-2 shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-900 rounded-bl-none'}`}>
                                                <p className="text-sm leading-relaxed">{msg.text}</p>
                                                <div className={`text-[10px] mt-1 flex items-center justify-end space-x-1 ${isMe ? 'text-blue-100' : 'text-gray-400'}`}><span>{msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</span><Icons.CheckCheck size={14} /></div>
                                            </div>
                                        </div>
                                    );
                                })}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="bg-white p-3 border-t border-gray-200">
                                <div className="flex items-center space-x-2">
                                    <input type="text" value={activeMessage} onChange={(e) => setActiveMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="Type message..." className="flex-1 bg-gray-100 border-0 rounded-full px-4 py-3 outline-none" />
                                    <button onClick={handleSendMessage} className="p-3 bg-blue-600 text-white rounded-full shadow-md"><Icons.Send size={20} /></button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 flex-col items-center justify-center bg-[#f0f2f5] p-8 text-center">
                            <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6"><Icons.MessageCircle size={48} className="text-blue-600" /></div>
                            <h2 className="text-2xl font-bold text-gray-700">Select a chat</h2>
                        </div>
                    )}
                </div>
            );
        };

        const Profile = ({ currentUser }) => (
            <div className="flex-1 flex flex-col items-center justify-center h-screen bg-gray-50 md:ml-64 pb-20 md:pb-0 fade-in">
                <div className="bg-white p-8 rounded-2xl shadow-sm text-center max-w-sm w-full">
                    <div className="w-24 h-24 mx-auto mb-4 rounded-full p-1 border-2 border-blue-500"><img src={currentUser.avatar} className="w-full h-full rounded-full bg-gray-200" /></div>
                    <h2 className="text-2xl font-bold text-gray-800">{currentUser.name}</h2>
                    <div className="bg-gray-100 rounded-lg p-3 mt-4 mb-6"><p className="text-xs text-gray-500 uppercase tracking-wide mb-1">Server ID</p><p className="font-mono text-sm text-gray-700 break-all select-all">{currentUser.id}</p></div>
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [activeTab, setActiveTab] = useState('feed');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(!auth) return;
                const unsub = auth.onAuthStateChanged(async (u) => {
                    setUser(u);
                    if (u) {
                        const docRef = db.collection(`${PUBLIC_DATA}_users`).doc(u.uid);
                        const snap = await docRef.get();
                        if (snap.exists) setUserProfile({ id: u.uid, ...snap.data() });
                        else setUserProfile(null);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleJoin = async (name) => {
                if (!user) { await auth.signInAnonymously(); }
                const u = auth.currentUser;
                const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;
                const data = { name, avatar, joinedAt: firebase.firestore.FieldValue.serverTimestamp() };
                await db.collection(`${PUBLIC_DATA}_users`).doc(u.uid).set(data);
                setUserProfile({ id: u.uid, ...data });
            };

            if (!auth) return (
                <div className="h-screen flex items-center justify-center flex-col p-4 text-center">
                    <div className="mb-4 text-red-600 font-bold text-xl">Configuration Needed</div>
                    <div className="text-gray-600 max-w-md bg-white p-6 rounded-xl shadow-lg">
                        <p className="mb-4">This app needs a database to function on GitHub Pages.</p>
                        <ol className="text-left text-sm space-y-2 list-decimal list-inside">
                            <li>Open <strong>index.html</strong> in a text editor.</li>
                            <li>Scroll to the <strong>GITHUB CONFIGURATION</strong> section.</li>
                            <li>Paste your Firebase keys there.</li>
                        </ol>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div>;
            if (!userProfile) return <AuthScreen onJoin={handleJoin} />;

            return (
                <div className="flex font-sans text-gray-900 bg-gray-100 min-h-screen">
                    <Navigation activeTab={activeTab} setActiveTab={setActiveTab} currentUser={userProfile} />
                    {activeTab === 'feed' && <Feed currentUser={userProfile} />}
                    {activeTab === 'chats' && <Messaging currentUser={userProfile} />}
                    {activeTab === 'profile' && <Profile currentUser={userProfile} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
